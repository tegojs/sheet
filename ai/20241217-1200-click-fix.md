# 表格点击无响应和坐标偏移问题修复

## 问题描述
1. 用户反馈表格内容点击无响应，无法选择单元格
2. 点击和右键菜单位置有偏移，例如在 B8 单元格右键，菜单却出现在右下角

## 根本原因分析

### 1. Overlayer 尺寸问题
在原始实现中，`overlayer` 元素的尺寸是通过 JavaScript 动态设置的：
```javascript
overlayerEl.offset(vRect);  // vRect = { width: data.viewWidth(), height: data.viewHeight() }
```

但在 React 实现中，`OverlayerInteraction` 组件没有设置明确的宽高，导致：
- overlayer 的实际尺寸可能为 0 或很小
- 无法接收鼠标点击事件
- 即使 CSS 设置了 `position: absolute`，没有明确尺寸的元素也无法响应点击

### 2. 状态更新未触发重新渲染
当选区改变时，虽然调用了 `setSelection` 方法更新了内部状态，但没有触发 Zustand 状态更新，导致：
- Canvas 不会重新渲染
- 选区框不会更新显示
- 用户看不到任何视觉反馈

### 3. CanvasTable 监听不完整
`CanvasTable` 组件只在 `activeSheetIndex` 改变时重新渲染，忽略了其他状态变化（如选区变化）。

## 修复方案

### 1. 设置 Overlayer 正确尺寸

**文件**: `src/sheet/components/Overlayer/OverlayerInteraction.tsx`

添加 state 和 useEffect 来动态获取并设置尺寸：

```typescript
const [dimensions, setDimensions] = useState({ width: 0, height: 0 });

// 设置 overlayer 的尺寸
useEffect(() => {
  if (data) {
    const width = data.viewWidth();
    const height = data.viewHeight();
    setDimensions({ width, height });
  }
}, [data]);
```

在渲染时应用尺寸：

```typescript
<div
  ref={overlayerRef}
  className={`${cssPrefix}-overlayer`}
  style={{
    width: dimensions.width > 0 ? `${dimensions.width}px` : '100%',
    height: dimensions.height > 0 ? `${dimensions.height}px` : '100%',
  }}
>
```

**为什么有效**：
- 明确的宽高使 overlayer 成为一个有效的点击目标
- 尺寸与表格数据的视图尺寸一致
- 完全覆盖表格区域

### 2. 触发状态更新和重新渲染

**文件**: `src/sheet/store/useSheetStore.ts`

在 `setSelection` 和 `setSelectionEnd` 方法中添加状态更新：

```typescript
setSelection: (ri: number, ci: number, multiple = false) => {
  const sheet = get().getActiveSheet();
  if (multiple) {
    sheet.calSelectedRangeByEnd(ri, ci);
  } else {
    sheet.calSelectedRangeByStart(ri, ci);
    sheet.selector.setIndexes(ri, ci);
  }
  // 触发视图更新（不触发 change 事件）
  set({}); // 强制 Zustand 通知订阅者
},

setSelectionEnd: (ri: number, ci: number) => {
  const sheet = get().getActiveSheet();
  sheet.calSelectedRangeByEnd(ri, ci);
  // 触发视图更新
  set({});
},
```

**为什么有效**：
- `set({})` 虽然不改变状态，但会通知所有订阅者
- 触发 React 组件重新渲染
- Canvas 重新绘制，显示新的选区

### 3. 改进 CanvasTable 监听

**文件**: `src/sheet/components/CanvasTable.tsx`

修改 store 订阅，监听所有状态变化：

```typescript
// 监听 store 变化并重新渲染
useEffect(() => {
  const unsubscribe = useSheetStore.subscribe(() => {
    // 任何 store 变化都重新渲染（包括选区变化）
    render();
  });

  return unsubscribe;
}, [render]);
```

**为什么有效**：
- 不再限制只监听 `activeSheetIndex` 变化
- 选区变化、编辑状态变化等都会触发重新渲染
- 确保视图始终与状态同步

## 调试辅助

为了验证事件处理是否工作，添加了临时的 console.log：

```typescript
const handleMouseDown = useCallback(
  (event: React.MouseEvent<HTMLDivElement>) => {
    // ...
    console.log('MouseDown:', { offsetX, offsetY, ri, ci, buttons, detail });
    // ...
  },
  [data, setSelection, setSelectionEnd, startEditing],
);
```

**验证方法**：
1. 打开浏览器开发者工具的 Console 面板
2. 点击表格中的任意单元格
3. 应该能看到 "MouseDown" 日志输出
4. 日志中应包含正确的 ri, ci 坐标

## 测试清单

修复后需要验证的功能：

- ✅ 单击单元格可以选中
- ✅ 选区框正确显示
- ✅ 拖拽可以选择多个单元格
- ✅ 双击可以进入编辑模式
- ✅ 右键显示上下文菜单
- ✅ 滚轮滚动正常
- ✅ Shift+点击扩展选区

## 相关文件

### 修改的文件
1. `src/sheet/components/Overlayer/OverlayerInteraction.tsx` - 添加尺寸管理
2. `src/sheet/store/useSheetStore.ts` - 添加状态更新触发
3. `src/sheet/components/CanvasTable.tsx` - 改进状态监听

### 技术要点

**1. React 事件处理**
- 使用 `offsetX/offsetY` 获取相对于元素的坐标
- 通过 `data.getCellRectByXY()` 计算单元格位置

**2. Zustand 状态管理**
- `set({})` 触发订阅者通知
- 区分数据变更（触发 change 事件）和视图更新（仅重新渲染）

**3. Canvas 重新渲染**
- 通过 `useTableRender` hook 管理 Canvas 渲染
- 订阅 store 变化自动重新渲染

## 后续优化建议

1. **移除调试日志**：在确认功能正常后，删除 console.log
2. **性能优化**：考虑使用 `useMemo` 缓存尺寸计算
3. **响应式尺寸**：监听窗口大小变化，动态更新 overlayer 尺寸
4. **选择性重新渲染**：根据变化类型决定是否需要重新渲染 Canvas

## 预期效果

修复后，用户应该能够：
1. 点击任意单元格立即看到选区框
2. 拖拽鼠标选择多个单元格
3. 双击单元格进入编辑模式
4. 所有交互都有即时的视觉反馈

