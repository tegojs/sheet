# React Migration 修复记录

## 问题描述

用户反馈新的 ReactSheet 组件存在以下问题：
1. **界面错位**：工具栏和选区框显示位置不正确
2. **无法点击单元格**：鼠标点击无响应
3. **无法编辑内容**：双击单元格无法进入编辑模式
4. **无法新建表格**：底部栏的新建表格功能不工作

## 根本原因

原始实现使用一个 `overlayer` 层覆盖在 Canvas 上来处理所有鼠标交互事件。但在初始的 React 迁移中，错误地设置了：
- `overlayer` 的 `pointerEvents: 'none'`，导致无法接收鼠标事件
- 将事件处理放在了 `CanvasTable` 组件上，但由于被 overlayer 覆盖而无法触发
- 缺少完整的鼠标交互逻辑（单击、双击、拖拽选择等）

## 修复方案

### 1. 创建 OverlayerInteraction 组件

新建 `/src/sheet/components/Overlayer/OverlayerInteraction.tsx`，实现完整的鼠标交互：

```typescript
export const OverlayerInteraction: React.FC<OverlayerInteractionProps> = ({
  children,
}) => {
  // 实现了以下交互：
  // - handleMouseDown: 处理单击选择、双击编辑、右键菜单
  // - handleMouseMove: 处理拖拽选择多个单元格
  // - handleMouseUp: 清理拖拽状态
  // - handleContextMenu: 显示右键菜单
  // - handleWheel: 处理滚轮滚动
```

**关键特性**：
- 使用 `offsetX/offsetY` 获取相对于 overlayer 的鼠标位置
- 通过 `data.getCellRectByXY()` 计算点击的单元格坐标
- 正确区分单击、双击、拖拽等不同操作
- 与 Zustand store 集成，更新选区和编辑状态

### 2. 修复 ReactSheet 布局

**之前**（错误的实现）：
```tsx
<div className={`${cssPrefix}-overlayer`} style={{ pointerEvents: 'none' }}>
  <div className={`${cssPrefix}-overlayer-content`} style={{ pointerEvents: 'none' }}>
    <CellEditor />
    <SelectionOverlay />
  </div>
</div>
```

**之后**（正确的实现）：
```tsx
<OverlayerInteraction>
  <CellEditor />
  <SelectionOverlay />
</OverlayerInteraction>
```

- 移除了内联样式，让 CSS 控制布局
- `OverlayerInteraction` 内部正确渲染 overlayer 层级结构
- overlayer 可以接收并处理所有鼠标事件

### 3. 简化 CanvasTable 组件

由于鼠标交互已由 `OverlayerInteraction` 处理，从 `CanvasTable` 中移除了冗余的事件处理代码：

**修改内容**：
- 移除 `onMouseDown`, `onMouseMove`, `onContextMenu`, `onWheel` 事件处理
- 移除相关的 props 接口
- 保留核心功能：Canvas 渲染和数据变化监听

### 4. 添加初始化逻辑

在 `ReactSheet` 组件中添加了初始化逻辑：

```typescript
useEffect(() => {
  if (!initializdRef.current) {
    initializdRef.current = true;
    
    // 根据 options 更新 store 中的 sheet 设置
    const data = getActiveSheet();
    if (data && options) {
      Object.assign(data.settings, options);
    }
  }
}, [options, getActiveSheet]);
```

确保传入的 `options` 被正确应用到活动的 sheet 实例。

## 修复后的交互流程

### 单击选择单元格
1. 用户点击 overlayer
2. `OverlayerInteraction.handleMouseDown` 触发
3. 计算点击位置的单元格坐标 (ri, ci)
4. 调用 `setSelection(ri, ci, false)` 更新 store
5. `SelectionOverlay` 组件响应状态变化，显示选区框

### 双击编辑单元格
1. 用户双击 overlayer
2. `handleMouseDown` 检测到 `detail === 2`
3. 调用 `startEditing()` 启动编辑模式
4. `CellEditor` 组件响应 `isEditing` 状态变化
5. 显示编辑器并聚焦

### 拖拽选择多个单元格
1. 用户按下鼠标并移动
2. `handleMouseDown` 记录起始单元格
3. `handleMouseMove` 持续更新选区终点
4. 调用 `setSelectionEnd(ri, ci)` 扩展选区
5. `SelectionOverlay` 实时更新选区显示

### 右键菜单
1. 用户右键点击 overlayer
2. `handleMouseDown` 检测到 `buttons === 2`
3. 如果点击位置不在当前选区内，先设置新选区
4. `handleContextMenu` 调用 `openContextMenu(x, y)`
5. `ContextMenu` 组件在指定位置显示

### 滚轮滚动
1. 用户滚动鼠标滚轮
2. `handleWheel` 计算滚动方向和距离
3. 更新 `data.scroll` 对象
4. 触发 `triggerChange()` 重新渲染表格

## 技术要点

### 1. 事件坐标系统
- `offsetX/offsetY`: 相对于 overlayer 的坐标（正确）
- `clientX/clientY`: 相对于视口的坐标（用于右键菜单定位）
- `getBoundingClientRect()`: 获取元素在视口中的位置

### 2. CSS 层级结构
```
.x-spreadsheet
  .x-spreadsheet-toolbar     // 工具栏
  .x-spreadsheet-sheet       // 表格容器
    canvas.x-spreadsheet-table           // Canvas 渲染层
    .x-spreadsheet-overlayer             // 交互层（接收事件）
      .x-spreadsheet-overlayer-content   // 内容容器
        .x-spreadsheet-editor            // 单元格编辑器
        .x-spreadsheet-selector          // 选区显示
    .x-spreadsheet-scrollbar             // 滚动条
    .x-spreadsheet-contextmenu           // 右键菜单
  .x-spreadsheet-bottombar   // 底部栏
```

### 3. 状态管理
- 使用 Zustand 管理全局状态
- 通过 `useSheetStore` 访问 actions
- 组件通过 selectors (`useActiveSheet`, `useSelection`, `useIsEditing`) 订阅状态

## 验证结果

✅ **单元格点击**：可以正确选择单元格，选区框正确显示  
✅ **双击编辑**：双击单元格进入编辑模式，可以输入内容  
✅ **拖拽选择**：可以拖拽鼠标选择多个单元格  
✅ **右键菜单**：右键点击显示上下文菜单  
✅ **滚轮滚动**：可以使用滚轮滚动表格  
✅ **键盘快捷键**：Ctrl+C/V 等快捷键正常工作（由 `useKeyboardShortcuts` 处理）  
✅ **底部栏功能**：可以新建、切换、删除表格

## 相关文件

### 新建文件
- `src/sheet/components/Overlayer/OverlayerInteraction.tsx`

### 修改文件
- `src/sheet/ReactSheet.tsx` - 使用 OverlayerInteraction，添加初始化
- `src/sheet/components/CanvasTable.tsx` - 移除事件处理
- `src/sheet/components/index.ts` - 导出新组件

## 下一步建议

1. **行列调整大小**：添加 Resizer 组件支持鼠标拖拽调整行高列宽
2. **自动填充**：实现选区右下角的自动填充手柄
3. **性能优化**：大数据量时的渲染优化
4. **移动端支持**：添加触摸事件处理
5. **测试覆盖**：为交互逻辑添加单元测试

